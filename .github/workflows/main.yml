name: Build reFlutter Android ARM64 Only

# NOTE: ARM64-only builds require ~40-50GB disk space and take 3-5 hours
# GitHub Actions free runners may still run out of space
# Consider using self-hosted runners for reliable builds

on:
  workflow_dispatch:
    inputs:
      snapshot_hash:
        description: 'Snapshot Hash (e.g., d91c0e6f35f0eb2e44124e8f42aa44a7)'
        required: true
        type: string
      engine_commit:
        description: 'Engine Commit (e.g., cf56914b326edb0ccb123ffdc60f00060bd513fa)'
        required: true
        type: string
      wait_time:
        description: 'Wait Time in seconds (for source code modifications)'
        required: false
        default: '300'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest  # Standard free runner
    timeout-minutes: 480  # 8 hours max (builds can take a long time)
    
    steps:
      - name: Free up disk space
        run: |
          echo "=== Before cleanup ==="
          df -h
          
          # Remove unnecessary packages
          sudo apt-get remove -y '^aspnetcore-.*' '^dotnet-.*' '^llvm-.*' 'php.*' '^mongodb-.*' '^mysql-.*' azure-cli google-chrome-stable firefox powershell mono-devel libgl1-mesa-dri
          sudo apt-get autoremove -y
          sudo apt-get clean
          
          # Remove large directories
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /imagegeneration
          sudo rm -rf /usr/local/graalvm/
          sudo rm -rf /usr/local/.ghcup/
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf /usr/local/lib/node_modules
          
          # Remove Docker images we don't need
          docker rmi $(docker image ls -aq) 2>/dev/null || true
          
          echo ""
          echo "=== After cleanup ==="
          df -h
          
          # Check if we have at least 50GB free
          FREE_SPACE=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
          echo ""
          echo "Free space: ${FREE_SPACE}GB"
          
          if [ "$FREE_SPACE" -lt 50 ]; then
            echo "âš ï¸  WARNING: Only ${FREE_SPACE}GB free. Flutter engine builds typically need 50GB+"
            echo "Build may fail due to insufficient disk space"
          fi
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Clone reFlutter
        run: |
          git clone https://github.com/Impact-I/reFlutter
          cd reFlutter
          echo "reFlutter repository contents:"
          ls -lah
      
      - name: Create custom Dockerfile with Ninja fix
        run: |
          cd reFlutter
          # Backup original
          cp Dockerfile Dockerfile.original
          
          # Create modified Dockerfile with ninja-build package
          cat > Dockerfile << 'DOCKERFILE_END'
          FROM ubuntu:22.04
          ARG HASH_PATCH
          ARG COMMIT
          ARG arm
          ARG arm64
          ARG x64
          ENV DEPOT_TOOLS_PATH=/depot_tools
          ENV TEMP_ENGINE=/engine
          ENV ENGINE_PATH=/customEngine
          ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/depot_tools
          ENV WAIT=4
          ENV arm64=${arm64:-arm64-v8a}
          ENV arm=${arm:-armeabi-v7a}
          ENV x64=${x64:-x86_64}
          ENV HASH_PATCH=$HASH_PATCH
          ENV COMMIT=$COMMIT
          
          RUN apt-get update && \
            DEBIAN_FRONTEND="noninteractive" apt-get install -y \
            git git-svn git-man wget curl software-properties-common unzip \
            python3-pip python3 lsb-release sudo apt-transport-https tzdata \
            python3-pkgconfig default-jre default-jdk ninja-build && \
            mkdir t
          
          ENTRYPOINT ["/bin/sh", "-c", "\
          cd /t && \
          pip3 install wheel && \
          pip3 install . && \
          rm -rf ${DEPOT_TOOLS_PATH} 2> /dev/null && \
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git ${DEPOT_TOOLS_PATH} && \
          rm -rf ${TEMP_ENGINE} 2> /dev/null && \
          git clone https://github.com/flutter/flutter.git ${TEMP_ENGINE} && \
          rm -rf ${ENGINE_PATH} 2> /dev/null && \
          mkdir -p ${ENGINE_PATH} && \
          cd ${TEMP_ENGINE} && \
          git config --global user.email \"reflutter@example.com\" && \
          git config --global user.name \"reflutter\" && \
          git fetch origin ${COMMIT} && \
          git reset --hard FETCH_HEAD && \
          reflutter -b ${HASH_PATCH} -p && \
          echo 'reflutter' > REFLUTTER && \
          git add . && \
          git commit -am \"reflutter\" && \
          cd ${ENGINE_PATH} && \
          echo 'solutions = [{\"managed\": False,\"name\": \".\",\"url\": \"'${TEMP_ENGINE}'\",\"custom_deps\": {},\"deps_file\": \"DEPS\",\"safesync_url\": \"\",},]' > .gclient && \
          gclient sync && \
          reflutter -b ${HASH_PATCH} -p && \
          echo \"Wait... Change the source code...\" && \
          sleep $WAIT && \
          export NINJA_SUMMARIZE_BUILD=1 && \
          if [ \"$arm64\" != \"0\" ]; then \
            engine/src/flutter/tools/gn --no-goma --android --android-cpu=arm64 --runtime-mode=release && \
            ninja -C engine/src/out/android_release_arm64 && \
            cp engine/src/out/android_release_arm64/lib.stripped/libflutter.so /libflutter_arm64.so; \
          fi && \
          if [ \"$arm\" != \"0\" ]; then \
            engine/src/flutter/tools/gn --no-goma --android --android-cpu=arm --runtime-mode=release && \
            ninja -C engine/src/out/android_release && \
            cp engine/src/out/android_release/lib.stripped/libflutter.so /libflutter_arm.so; \
          fi && \
          if [ \"$x64\" != \"0\" ]; then \
            engine/src/flutter/tools/gn --no-goma --android --android-cpu=x64 --runtime-mode=release && \
            ninja -C engine/src/out/android_release_x64 && \
            cp engine/src/out/android_release_x64/lib.stripped/libflutter.so /libflutter_x64.so; \
          fi && \
          cd .. && \
          cp -va *.so /t/"]
          
          CMD ["bash"]
          DOCKERFILE_END
          
          echo "Modified Dockerfile created with ninja-build package"
      
      - name: Build Docker image
        run: |
          cd reFlutter
          docker build -t reflutter \
            --build-arg HASH_PATCH=${{ inputs.snapshot_hash }} \
            --build-arg COMMIT=${{ inputs.engine_commit }} \
            --build-arg arm64=arm64-v8a \
            --build-arg arm=0 \
            --build-arg x64=0 \
            -f Dockerfile .
      
      - name: Create output directory
        run: mkdir -p ${{ github.workspace }}/output
      
      - name: Run reFlutter build
        run: |
          cd reFlutter
          
          echo "=== Building ARM64 only ==="
          echo "This will take approximately 3-5 hours"
          echo ""
          
          # Start disk space monitoring in background
          (while true; do 
            echo "=== Disk Usage [$(date +%T)] ===" 
            df -h / | tail -n1
            sleep 300  # Check every 5 minutes
          done) &
          MONITOR_PID=$!
          
          # Run the build (ARM64 ONLY)
          docker run \
            -e WAIT=${{ inputs.wait_time }} \
            -e arm64=arm64-v8a \
            -e arm=0 \
            -e x64=0 \
            -e HASH_PATCH=${{ inputs.snapshot_hash }} \
            -e COMMIT=${{ inputs.engine_commit }} \
            --rm \
            -v "$(pwd):/t" \
            reflutter
          
          # Stop monitoring
          kill $MONITOR_PID 2>/dev/null || true
      
      - name: List build output
        run: |
          echo "=== reFlutter directory contents ==="
          ls -lah reFlutter/
          echo ""
          echo "=== Looking for .so files ==="
          find reFlutter/ -name "*.so" -type f || echo "No .so files found"
      
      - name: Copy artifacts to output directory
        run: |
          cd reFlutter
          if [ -f libflutter_arm64.so ]; then
            cp libflutter_arm64.so ${{ github.workspace }}/output/
            echo "âœ“ Copied libflutter_arm64.so"
            ls -lh libflutter_arm64.so
          else
            echo "âŒ libflutter_arm64.so not found!"
            exit 1
          fi
          
          # Create a build info file
          cat > ${{ github.workspace }}/output/build_info.txt << EOF
          reFlutter ARM64 Build Information
          ==================================
          Snapshot Hash: ${{ inputs.snapshot_hash }}
          Engine Commit: ${{ inputs.engine_commit }}
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Architecture: ARM64 (arm64-v8a)
          Runner: GitHub Actions
          EOF
          
          echo ""
          echo "=== Final output directory ==="
          ls -lah ${{ github.workspace }}/output/
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: reflutter-android-${{ inputs.snapshot_hash }}-${{ github.run_number }}
          path: output/*
          retention-days: 30
          if-no-files-found: warn
      
      - name: Create Release
        if: success() && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: reFlutter ARM64 Build ${{ github.run_number }}
          body: |
            ## reFlutter Android ARM64 Build
            
            **Configuration:**
            - ðŸ“± Snapshot Hash: `${{ inputs.snapshot_hash }}`
            - ðŸ”§ Engine Commit: `${{ inputs.engine_commit }}`
            - â±ï¸ Wait Time: ${{ inputs.wait_time }}s
            - ðŸ—ï¸ Architecture: ARM64 (arm64-v8a) only
            
            **Files:**
            - `libflutter_arm64.so` - ARM64 library for Android
            - `build_info.txt` - Build metadata
            
            **Usage:**
            Replace the `libflutter.so` in your Flutter APK's `lib/arm64-v8a/` directory with this patched version.
          files: output/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build summary
        if: always()
        run: |
          echo "### reFlutter ARM64 Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Snapshot Hash: \`${{ inputs.snapshot_hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Engine Commit: \`${{ inputs.engine_commit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Wait Time: ${{ inputs.wait_time }}s" >> $GITHUB_STEP_SUMMARY
          echo "- Architecture: ARM64 (arm64-v8a) only" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f output/libflutter_arm64.so ]; then
            size=$(ls -lh output/libflutter_arm64.so | awk '{print $5}')
            echo "**âœ… Build Successful**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Built Artifact:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`libflutter_arm64.so\` ($size)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**âŒ Build Failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No ARM64 library was generated. Check the logs for errors." >> $GITHUB_STEP_SUMMARY
          fi
