name: Build reFlutter Android ARM64

on:
  workflow_dispatch:
    inputs:
      snapshot_hash:
        description: 'Snapshot Hash'
        required: true
        type: string
      engine_commit:
        description: 'Engine Commit'
        required: true
        type: string
      wait_time:
        description: 'Wait Time (seconds)'
        required: false
        default: '300'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Clone reFlutter
        run: |
          git clone https://github.com/Impact-I/reFlutter
          cd reFlutter
      
      - name: Build Docker image
        run: |
          cd reFlutter
          docker build -t reflutter -f Dockerfile .
      
      - name: Create output directory
        run: mkdir -p output
      
      - name: Run reFlutter build for ARM64
        run: |
          docker run \
            -e WAIT=${{ inputs.wait_time }} \
            -e x64=0 \
            -e arm=0 \
            -e HASH_PATCH=${{ inputs.snapshot_hash }} \
            -e COMMIT=${{ inputs.engine_commit }} \
            --rm \
            -v ${{ github.workspace }}/output:/t \
            reflutter
      
      - name: List built artifacts
        run: |
          echo "Built artifacts:"
          ls -lah output/
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: reflutter-arm64-${{ inputs.snapshot_hash }}
          path: output/*
          retention-days: 30
      
      - name: Create Release (Optional)
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: reFlutter ARM64 Build ${{ github.run_number }}
          body: |
            **Build Configuration:**
            - Snapshot Hash: `${{ inputs.snapshot_hash }}`
            - Engine Commit: `${{ inputs.engine_commit }}`
            - Architecture: ARM64
            - Wait Time: ${{ inputs.wait_time }}s
          files: output/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
