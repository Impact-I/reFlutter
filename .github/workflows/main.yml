name: Build reFlutter Android ARM64

on:
  workflow_dispatch:
    inputs:
      snapshot_hash:
        description: 'Snapshot Hash'
        required: true
        type: string
      engine_commit:
        description: 'Engine Commit'
        required: true
        type: string
      wait_time:
        description: 'Wait Time (seconds)'
        required: false
        default: '300'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Clone reFlutter
        run: |
          git clone https://github.com/Impact-I/reFlutter
          cd reFlutter
      
      - name: Build Docker image
        run: |
          cd reFlutter
          docker build -t reflutter -f Dockerfile .
      
      - name: Create output directory
        run: mkdir -p output
      
      - name: Check reFlutter directory structure
        run: |
          echo "reFlutter directory contents:"
          ls -lah reFlutter/
      
      - name: Copy reFlutter files to output (if needed)
        run: |
          # Copy any necessary files from reFlutter to output directory
          if [ -f reFlutter/setup.py ]; then
            cp reFlutter/setup.py output/
          fi
          if [ -f reFlutter/pyproject.toml ]; then
            cp reFlutter/pyproject.toml output/
          fi
      
      - name: Run reFlutter build for ARM64
        run: |
          cd reFlutter
          docker run \
            -e WAIT=${{ inputs.wait_time }} \
            -e x64=0 \
            -e arm=0 \
            -e HASH_PATCH=${{ inputs.snapshot_hash }} \
            -e COMMIT=${{ inputs.engine_commit }} \
            --rm \
            -v "$(pwd):/t" \
            reflutter
      
      - name: Copy built artifacts
        run: |
          echo "Copying artifacts from reFlutter directory..."
          cp -r reFlutter/*.so output/ 2>/dev/null || true
          cp -r reFlutter/*.zip output/ 2>/dev/null || true
          cp -r reFlutter/build output/ 2>/dev/null || true
      
      - name: List built artifacts
        run: |
          echo "Built artifacts:"
          ls -lah output/ || echo "No output directory"
          echo ""
          echo "reFlutter directory after build:"
          ls -lah reFlutter/
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: reflutter-arm64-${{ inputs.snapshot_hash }}
          path: |
            output/*
            reFlutter/*.so
            reFlutter/*.zip
            reFlutter/build/**
          retention-days: 30
          if-no-files-found: warn
      
      - name: Create Release (Optional)
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: reFlutter ARM64 Build ${{ github.run_number }}
          body: |
            **Build Configuration:**
            - Snapshot Hash: `${{ inputs.snapshot_hash }}`
            - Engine Commit: `${{ inputs.engine_commit }}`
            - Architecture: ARM64
            - Wait Time: ${{ inputs.wait_time }}s
          files: output/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
